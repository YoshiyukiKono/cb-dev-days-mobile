## データモデリング

[(英文)](https://docs.couchbase.com/tutorials/mobile-travel-sample/android/design/data-modeling.html)

### 序章

ドキュメントスキーマの説明の前に、モバイルアプリをもう一度見てみましょう。
モバイルアプリを実行したとき、ログイン画面に2つの異なるオプションが表示されます。

![](https://cl.ly/1s2L2Q372d2m/android-login.png)

- ログイン(同期モード)：提供されたユーザー資格情報を使用して、データをCouchbase Serverと同期します。WEBアプリケーションなど、別の端末でログインした場合もデータが引き継がれます。
- ゲスト(非同期モード)：ユーザーの資格情報を必要としないローカルのみのモードです。ローカルデータベースで作成されたドキュメントは、Sync Gatewayで同期されません。

![](https://raw.githubusercontent.com/couchbaselabs/mobile-travel-sample/master/content/assets/travel%20sample%20mobile.png)

次のレッスンでは、これら2つのモードを切り替えて、さまざまな機能をテストします。データモデルは、これら2つのモード間でわずかに異なることに注意してください。それぞれのデータモデルを確認してみましょう。

### 同期モード
アプリケーションは（Sync Gatewayを介して）Couchbase　Serverと通信します。Couchbase　Serverのバケットに保存されているドキュメントの種類は次のとおりです。

- airline
- airport
- hotel
- route
- user

- `user`ドキュメントを除いて、残りのドキュメントは本質的に更新されません（静的/半静的です）。

- `hotel`および`airport`ドキュメントは、Couchbase　Liteデータベースにバンドルされており、アプリが起動されるとロードされます。チュートリアルの「ビルトインデータベース」セクションで、ビルトインデータベースの検索と使用について詳しく説明します。

- `airline`、`airport`、`hotel`、`route`文書はデータベースとして同期されていません。代わりに、Travel Sample Webバックエンドによって公開されているRESTWebサービスAPIを介してアプリによってフェッチされます。

![](https://cl.ly/40330Z0M1k3F/models.png)

### ゲスト/非同期モード
ゲストモードでは、モバイルアプリは匿名ユーザー用の新しいデータベースを作成します。これは、ブックマークされたホテルのリストをローカルに保存するための空のデータベースです。

アプリケーションの実際の利用との関係でいうと、Travel Sample Mobileアプリのユーザーは、実際にサインアップしなくても、特定の検索条件を満たす特定の場所にあるホテルを閲覧することに関心があると考えられます。
彼らはこれらのホテルをブックマークして、後で旅行の予約に追加することができます。これらのブックマークされたホテルは、他のユーザー、たとえば旅行の予約をしているユーザーと共有することもできます。

ゲストモードでは、Couchbase Liteデータベースは次のタイプのドキュメントをホストします。

- bookmarkedhotels
- hotel

![](https://cl.ly/2l0118183p11/guest-model.png)

### ドキュメントタイプ
Couchbase Lite(および、バージョン6.xまでのCouchbase Server)では、RDBのテーブルとは異なり、すべてのドキュメントが同じ名前空間に保存されます。
したがって、通常は追加のプロパティを使用して、各エンティティを区別します。このプロパティは、「type」と名付けられています。

![](https://cl.ly/1w2D1Z2J0p47/document-types.png)

### やってみよう
- インストール時に使用したのと同じ管理者クレデンシャルを使用して、CouchbaseServerの「管理コンソール」にログインします。
- 左側のメニューから「バケット」オプションを選択します
- 旅行サンプルバケットの下にある[ドキュメント]をクリックします
- ID「hotel_10025」のドキュメントを検索します
- ドキュメントの「type」プロパティが「hotel」であることを確認します

### ドキュメントキー/ ID
Couchbaseのすべてのドキュメントは、ドキュメントの作成時にユーザーが提供する必要のある一意のキーに関連付けられています。
キーはドキュメントの一意の識別子であり、任意の形式をとることができます。
ただし、ドキュメントの内容に関するコンテキストを提供する値を指定することができます。
たとえば、旅行アプリのデータセットでは、ドキュメントのキー/IDの形式は{doc.type}_{alphanumeric_string}です。
ここで{doc.type}は、ドキュメントの目的のコンテキストを提供し、と組み合わせて{alphanumeric_string}、文字列を一意に識別します。
ドキュメントキーは、Couchbase Server管理コンソールに「ID」として表示されます。キーはドキュメントIDとも呼ばれます。

![](https://cl.ly/0K3V1q3m3K1Z/admin-ui.png)

### やってみよう
- インストール時に作成した適切な管理者クレデンシャルを使用して、Couchbase Serverの「管理コンソール」にログインします。
- 左側のメニューから「Buckets」オプションを選択します
- travel-sampleバケットの下にある「Documents」をクリックします
- ID「airline_137」のドキュメントを検索します
- ドキュメントの「callsign」プロパティが「AIRFRANS」であることを確認します

### ドキュメント_id
Sync Gatewayはドキュメントを処理するときに、関連するメタデータをドキュメントに追加します。メタデータには、ドキュメントIDに対応する「`_id`」プロパティが含まれています。
Sync Gateway REST APIを介してドキュメントをクエリすると、このプロパティが表示されます。

```
{
    "_id": "airline_137",
    "_rev": "1-b4e60280a1a0e3d46efad7bfd0e2068c",
    "callsign": "AIRFRANS",
    "country": "France",
    "iata": "AF",
    "icao": "AFR",
    "id": 137,
    "name": "Air France",
    "type": "airline"
}
```

Couchbase Liteを使用するモバイルアプリ開発者は、通常、`_id`プロパティを直接読み書きする必要はありません。
`META().id`フィールドをクエリの中で用いて、ドキュメントIDを取得あるいは検索条件に利用することができます。
これについては、クエリレッスンで詳しく学習します。

[目次へ戻る](./README.md)
